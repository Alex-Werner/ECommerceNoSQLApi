var express = require( 'express' );
var Deferred = require( 'JQDeferred' );

require( "skyerp/utils/inherits.js" );
var db = require( "skyerp/dao/db.js" );
var logger = require( 'skyerp/debug/logger.js' );
var config = require( 'skyerp/conf/conf.js' );
var restUtils = require( "skyerp/utils/rest_helper.js" );
var route_root = require( 'skyerp/routes/root.js' );
var route_skyerp = require( 'skyerp/routes/skyerp.js' );

/**
 * @class skyerp.Server
 * @extends Object
 *
 * Launch a rest server on port defined in skyerp/conf/conf.json
 *
 */
var Server = Object.subClass( {
    /**
     * Constructeur
     */
    init: function ( ) {
        this.r = express( );
        // this.r.use(express.bodyParser());

        this.setup( );
    },

    /**
     * Configuration des urls
     */
    setup: function ( ) {
        var r = this.r;
        var that = this;

        console.log( __dirname );

        r.configure( function ( ) {
            r.use( express.logger( ) );
            r.use( express.methodOverride( ) );
            r.use( express.bodyParser());
            //r.use( '/static', express.static( __dirname + '/public' ) );
           // r.use( '/www', express.static( __dirname + '/www' ) );
        } );
        r.use(express.bodyParser());

        r.post('/sub',function(req,res)
        {
            res.on('data', function(chunk) {
                    queryResponse+=chunk;
                    console.log('data');
                });
            logger.info(req.params);
            res.end("ok");
        });

        r.get( '/', route_skyerp.root );
        r.get('/insertDemoProduct',route_skyerp.insertDemoProduct);
        r.get( '/consult/product/:pid', route_skyerp.consultProduct );

        r.get('/insertDemoCustomer',route_skyerp.insertDemoCustomer);
        r.get( '/consult/customer/:cid', route_skyerp.consultCustomer );

        r.get('/insertDemoCategorie',route_skyerp.insertDemoCategorie);
        r.get( '/consult/categorie/:cid', route_skyerp.consultCategorie );

        //r.get( '/hello/product/:pid/', route_skyerp.helloProduct );

        //r.get( '/skyerp/product/:productid/consult', route_skyerp.consultProduct );


        r.use( function ( req, res, next ) {
            restUtils.setResponseHeader( 'text/plain', res );
            res.send( 404, 'Page introuvable !' );
        } );

    },

    /**
     * Listener HTTP
     */
    listen: function ( ) {
        var port = config.rest.port;
        logger.info( "Run server on port: " + port );
        logger.info(this.r.listen);
        this.r.listen(port);
		
    }
} );

// Export du module
module.exports = new Server( );