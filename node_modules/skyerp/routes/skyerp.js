var express = require( 'express' );

var logger = require( 'skyerp/debug/logger.js' );
var restUtils = require( "skyerp/utils/rest_helper.js" );
var db = require( "skyerp/dao/db.js" );

module.exports = function ( ) {
    var app = express( );
    app.use( express.bodyParser( ) );

    app.root = function ( req, res ) {
        restUtils.setResponseHeader( 'text/plain', res );
        res.end( "Hello ROOT!" );
    };
    app.helloProduct = function ( req, res, next) {
        restUtils.setResponseHeader('application/json',res);
        res.header("Access-Control-Allow-Origin", "*");
        var productid = req.params.pid;
        res.end( "Hello %s!",productid );
    };

    /* PRODUCTS */
    app.insertDemoProduct = function (req,res) {
        restUtils.setResponseHeader('application/json',res);
        var result = {};
        db.insertDemoProduct(req.body)
        .fail(function(err){
            logger.error(err);
            res.send(500,err);
        }).done(function(product){
            logger.info("Produit <%s> inséré", product.title);
            var result = {
                message : "Produit ajouté",
                productid: product.productid
            };
            res.end(JSON.stringify(result));
        });
    };
    app.consultProduct=function(req,res,next){
        restUtils.setResponseHeader('application/json',res);
        res.header("Access-Control-Allow-Origin", "*");
        var pid = req.params.pid;
        logger.info("Param productid=%s", pid);
        db.consultProduct(pid).fail(function(err)
        {
            logger.error(err);
            if ( typeof err === 404 ) {
                res.send( 404, "Produit introuvable" );
            }
            else {
                res.send( 500, err );
            }
        }).done( function ( product ) {
            logger.info( "Sérialisation du produit <%s>", product.title );
            delete product._id;
            res.end( JSON.stringify( product ) );
        } );

    };
    /* CUSTOMER */
    app.insertDemoCustomer = function (req,res) {
        restUtils.setResponseHeader('application/json',res);
        var result = {};
        db.insertDemoCustomer(req.body)
        .fail(function(err){
            logger.error(err);
            res.send(500,err);
        }).done(function(customer){
            logger.info("Customer <%s> inséré", customer.first_name);
            var result = {
                message : "customer ajouté",
                first_name: customer.first_name,
                last_name: customer.last_name
            };
            res.end(JSON.stringify(result));
        });
    };
    app.consultCustomer=function(req,res,next){
        restUtils.setResponseHeader('application/json',res);
        res.header("Access-Control-Allow-Origin", "*");
        var cid = req.params.cid;
        logger.info("Param productid=%s", cid);
        db.consultCustomer(cid).fail(function(err)
        {
            logger.error(err);
            if ( typeof err === 404 ) {
                res.send( 404, "Produit introuvable" );
            }
            else {
                res.send( 500, err );
            }
        }).done( function ( customer ) {
            logger.info( "Sérialisation du customer <%s>", customer.last_name );
            delete customer._id;
            res.end( JSON.stringify( customer ) );
        } );

    };
        /* Categories */
    app.insertDemoCategorie = function (req,res) {
        restUtils.setResponseHeader('application/json',res);
        var result = {};
        db.insertDemoCategorie(req.body)
        .fail(function(err){
            logger.error(err);
            res.send(500,err);
        }).done(function(categorie){
            logger.info("Categories <%s> inséré", categorie.title);
            var result = {
                message : "Categories ajouté",
                title: categorie.title
            };
            res.end(JSON.stringify(result));
        });
    };
    app.consultCategorie=function(req,res,next){
        restUtils.setResponseHeader('application/json',res);
        res.header("Access-Control-Allow-Origin", "*");
        var cid = req.params.cid;
        logger.info("Param productid=%s", cid);
        db.consultCategorie(cid).fail(function(err)
        {
            logger.error(err);
            if ( typeof err === 404 ) {
                res.send( 404, "Categories introuvable" );
            }
            else {
                res.send( 500, err );
            }
        }).done( function ( categorie ) {
            logger.info( "Sérialisation du Categories <%s>", categorie.title );
            delete categorie._id;
            res.end( JSON.stringify( categorie ) );
        } );

    };

    app.consult=function(req, res, next)
    {
        restUtils.setResponseHeader('application/json',res);
        res.header("Access-Control-Allow-Origin", "*");
        var productid = req.params.productid;
        logger.info("Param productid=%s", productid);

        db.consultProduct(productid).fail(function(err)
        {
            logger.err(err);
            if ( typeof err === 404 ) {
                res.send( 404, "Produit introuvable" );
            }
            else {
                res.send( 500, err );
            }
        }).done( function ( product ) {
            logger.info( "Sérialisation du produit <%s>", product.title );
            delete product._id;
            res.end( JSON.stringify( product ) );
        } );

    };
    app.submitter = function (request, response)
    {
        //LE JSON DOIT ETRE ENVOYE EN x-www-form-urlencoded
        //nom de variable : answers
        //valeur de variable : json answers.
        response.header("Access-Control-Allow-Origin", "*");
        //estUtils.setResponseHeader( 'application/json', response);

        var productid = request.params.productid;
        response.end("Final");
    };
    

    return app;
}( );